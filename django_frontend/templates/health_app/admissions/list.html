{% extends 'base.html' %}

{% block title %}Admissions - Health Management System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-bed me-2"></i>Patient Admissions
            </h1>
            <div class="btn-group" role="group">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAdmissionModal">
                    <i class="fas fa-plus me-2"></i>New Admission
                </button>
                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#bedManagementModal">
                    <i class="fas fa-bed me-2"></i>Bed Management
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ stats.active_admissions|default:0 }}</h4>
                        <small>Active Admissions</small>
                    </div>
                    <i class="fas fa-user-injured fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ stats.available_beds|default:0 }}</h4>
                        <small>Available Beds</small>
                    </div>
                    <i class="fas fa-bed fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ stats.occupied_beds|default:0 }}</h4>
                        <small>Occupied Beds</small>
                    </div>
                    <i class="fas fa-procedures fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ stats.discharged_today|default:0 }}</h4>
                        <small>Discharged Today</small>
                    </div>
                    <i class="fas fa-sign-out-alt fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filter -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-search me-2"></i>Search & Filter</h6>
            </div>
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-3">
                        <label for="search" class="form-label">Search</label>
                        <input type="text" class="form-control" id="search" name="search" placeholder="Patient name, admission ID..." value="{{ request.GET.search }}">
                    </div>
                    <div class="col-md-2">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">All Status</option>
                            <option value="admitted" {% if request.GET.status == 'admitted' %}selected{% endif %}>Admitted</option>
                            <option value="discharged" {% if request.GET.status == 'discharged' %}selected{% endif %}>Discharged</option>
                            <option value="transferred" {% if request.GET.status == 'transferred' %}selected{% endif %}>Transferred</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="ward" class="form-label">Ward</label>
                        <select class="form-select" id="ward" name="ward">
                            <option value="">All Wards</option>
                            <option value="general" {% if request.GET.ward == 'general' %}selected{% endif %}>General Ward</option>
                            <option value="icu" {% if request.GET.ward == 'icu' %}selected{% endif %}>ICU</option>
                            <option value="emergency" {% if request.GET.ward == 'emergency' %}selected{% endif %}>Emergency</option>
                            <option value="pediatric" {% if request.GET.ward == 'pediatric' %}selected{% endif %}>Pediatric</option>
                            <option value="maternity" {% if request.GET.ward == 'maternity' %}selected{% endif %}>Maternity</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="date_from" class="form-label">From Date</label>
                        <input type="date" class="form-control" id="date_from" name="date_from" value="{{ request.GET.date_from }}">
                    </div>
                    <div class="col-md-2">
                        <label for="date_to" class="form-label">To Date</label>
                        <input type="date" class="form-control" id="date_to" name="date_to" value="{{ request.GET.date_to }}">
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Admissions Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="admissions-tab" data-bs-toggle="tab" data-bs-target="#admissions" type="button" role="tab">
                            <i class="fas fa-list me-2"></i>Current Admissions
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="bed-status-tab" data-bs-toggle="tab" data-bs-target="#bed-status" type="button" role="tab">
                            <i class="fas fa-bed me-2"></i>Bed Status
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="discharge-tab" data-bs-toggle="tab" data-bs-target="#discharge" type="button" role="tab">
                            <i class="fas fa-sign-out-alt me-2"></i>Recent Discharges
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    <!-- Current Admissions Tab -->
                    <div class="tab-pane fade show active" id="admissions" role="tabpanel">
                        {% if admissions %}
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Admission ID</th>
                                            <th>Patient</th>
                                            <th>Ward/Room</th>
                                            <th>Bed Number</th>
                                            <th>Admission Date</th>
                                            <th>Attending Doctor</th>
                                            <th>Diagnosis</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for admission in admissions %}
                                        <tr>
                                            <td><strong>#{{ admission.id }}</strong></td>
                                            <td>
                                                <div>
                                                    <strong>{{ admission.client_name|default:"N/A" }}</strong>
                                                    {% if admission.client_age %}
                                                        <br><small class="text-muted">Age: {{ admission.client_age }}</small>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>{{ admission.ward|default:"N/A" }}</td>
                                            <td>
                                                {% if admission.bed_number %}
                                                    <span class="badge bg-info">{{ admission.bed_number }}</span>
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ admission.admission_date|date:"M d, Y H:i" }}</td>
                                            <td>{{ admission.attending_doctor|default:"N/A" }}</td>
                                            <td>
                                                {% if admission.diagnosis %}
                                                    {{ admission.diagnosis|truncatechars:30 }}
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if admission.status == 'admitted' %}
                                                    <span class="badge bg-success">Admitted</span>
                                                {% elif admission.status == 'discharged' %}
                                                    <span class="badge bg-primary">Discharged</span>
                                                {% elif admission.status == 'transferred' %}
                                                    <span class="badge bg-warning">Transferred</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ admission.status|title }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <button class="btn btn-sm btn-outline-primary view-admission" data-admission-id="{{ admission.id }}" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    {% if admission.status == 'admitted' %}
                                                    <button class="btn btn-sm btn-outline-success discharge-patient" data-admission-id="{{ admission.id }}" title="Discharge Patient">
                                                        <i class="fas fa-sign-out-alt"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-warning transfer-patient" data-admission-id="{{ admission.id }}" title="Transfer Patient">
                                                        <i class="fas fa-exchange-alt"></i>
                                                    </button>
                                                    {% endif %}
                                                    <div class="dropdown">
                                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                            <i class="fas fa-ellipsis-v"></i>
                                                        </button>
                                                        <ul class="dropdown-menu">
                                                            <li><a class="dropdown-item update-admission" href="#" data-admission-id="{{ admission.id }}"><i class="fas fa-edit me-2"></i>Update</a></li>
                                                            <li><a class="dropdown-item medical-history" href="#" data-admission-id="{{ admission.id }}"><i class="fas fa-file-medical me-2"></i>Medical History</a></li>
                                                            <li><a class="dropdown-item print-admission" href="#" data-admission-id="{{ admission.id }}"><i class="fas fa-print me-2"></i>Print Details</a></li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-bed fa-3x text-muted mb-3"></i>
                                <h4 class="text-muted">No Current Admissions</h4>
                                <p class="text-muted">No patients are currently admitted.</p>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAdmissionModal">
                                    <i class="fas fa-plus me-2"></i>Add First Admission
                                </button>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Bed Status Tab -->
                    <div class="tab-pane fade" id="bed-status" role="tabpanel">
                        <div class="row">
                            {% for ward in bed_status %}
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">{{ ward.name }} Ward</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <h5 class="text-success">{{ ward.available_beds|default:0 }}</h5>
                                                <small>Available</small>
                                            </div>
                                            <div class="col-4">
                                                <h5 class="text-danger">{{ ward.occupied_beds|default:0 }}</h5>
                                                <small>Occupied</small>
                                            </div>
                                            <div class="col-4">
                                                <h5 class="text-info">{{ ward.total_beds|default:0 }}</h5>
                                                <small>Total</small>
                                            </div>
                                        </div>
                                        <div class="progress mt-2">
                                            <div class="progress-bar bg-danger" role="progressbar" style="width: {{ ward.occupancy_rate|default:0 }}%"></div>
                                        </div>
                                        <small class="text-muted">Occupancy: {{ ward.occupancy_rate|default:0 }}%</small>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="col-12">
                                <div class="text-center py-4">
                                    <i class="fas fa-bed fa-2x text-muted mb-3"></i>
                                    <p class="text-muted">No bed status information available.</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Recent Discharges Tab -->
                    <div class="tab-pane fade" id="discharge" role="tabpanel">
                        {% if recent_discharges %}
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Patient</th>
                                            <th>Admission Date</th>
                                            <th>Discharge Date</th>
                                            <th>Length of Stay</th>
                                            <th>Discharge Reason</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for discharge in recent_discharges %}
                                        <tr>
                                            <td>{{ discharge.client_name|default:"N/A" }}</td>
                                            <td>{{ discharge.admission_date|date:"M d, Y" }}</td>
                                            <td>{{ discharge.discharge_date|date:"M d, Y" }}</td>
                                            <td>{{ discharge.length_of_stay|default:"N/A" }} days</td>
                                            <td>{{ discharge.discharge_reason|default:"N/A" }}</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary view-discharge" data-discharge-id="{{ discharge.id }}" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-sign-out-alt fa-2x text-muted mb-3"></i>
                                <p class="text-muted">No recent discharges.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Admission Modal -->
<div class="modal fade" id="addAdmissionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>New Patient Admission</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addAdmissionForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="patientSelect" class="form-label">Patient</label>
                                <select class="form-select" id="patientSelect" name="client_id" required>
                                    <option value="">Select Patient</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="admissionDate" class="form-label">Admission Date & Time</label>
                                <input type="datetime-local" class="form-control" id="admissionDate" name="admission_date" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="wardSelect" class="form-label">Ward</label>
                                <select class="form-select" id="wardSelect" name="ward" required>
                                    <option value="">Select Ward</option>
                                    <option value="general">General Ward</option>
                                    <option value="icu">ICU</option>
                                    <option value="emergency">Emergency</option>
                                    <option value="pediatric">Pediatric</option>
                                    <option value="maternity">Maternity</option>
                                    <option value="surgical">Surgical</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bedNumber" class="form-label">Bed Number</label>
                                <select class="form-select" id="bedNumber" name="bed_number">
                                    <option value="">Select Bed</option>
                                    <!-- Options will be populated based on ward selection -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="attendingDoctor" class="form-label">Attending Doctor</label>
                                <select class="form-select" id="attendingDoctor" name="attending_doctor_id" required>
                                    <option value="">Select Doctor</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="admissionType" class="form-label">Admission Type</label>
                                <select class="form-select" id="admissionType" name="admission_type">
                                    <option value="emergency">Emergency</option>
                                    <option value="elective">Elective</option>
                                    <option value="transfer">Transfer</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="chiefComplaint" class="form-label">Chief Complaint</label>
                        <textarea class="form-control" id="chiefComplaint" name="chief_complaint" rows="2" placeholder="Primary reason for admission"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="diagnosis" class="form-label">Provisional Diagnosis</label>
                        <textarea class="form-control" id="diagnosis" name="diagnosis" rows="2" placeholder="Initial diagnosis"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="vitalSigns" class="form-label">Vital Signs</label>
                                <textarea class="form-control" id="vitalSigns" name="vital_signs" rows="3" placeholder="BP, HR, Temperature, etc."></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="allergies" class="form-label">Known Allergies</label>
                                <textarea class="form-control" id="allergies" name="allergies" rows="3" placeholder="Drug allergies, food allergies, etc."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="treatmentPlan" class="form-label">Initial Treatment Plan</label>
                        <textarea class="form-control" id="treatmentPlan" name="treatment_plan" rows="3" placeholder="Immediate treatment and care plan"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="admissionNotes" class="form-label">Admission Notes</label>
                        <textarea class="form-control" id="admissionNotes" name="notes" rows="2" placeholder="Additional notes"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Admit Patient</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Discharge Patient Modal -->
<div class="modal fade" id="dischargeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-sign-out-alt me-2"></i>Discharge Patient</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="dischargeForm">
                <div class="modal-body">
                    <input type="hidden" id="dischargeAdmissionId" name="admission_id">
                    <div class="mb-3">
                        <label for="dischargeDate" class="form-label">Discharge Date & Time</label>
                        <input type="datetime-local" class="form-control" id="dischargeDate" name="discharge_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="dischargeReason" class="form-label">Discharge Reason</label>
                        <select class="form-select" id="dischargeReason" name="discharge_reason" required>
                            <option value="">Select Reason</option>
                            <option value="recovered">Recovered</option>
                            <option value="improved">Condition Improved</option>
                            <option value="transfer">Transfer to Another Facility</option>
                            <option value="against_advice">Against Medical Advice</option>
                            <option value="deceased">Deceased</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="dischargeSummary" class="form-label">Discharge Summary</label>
                        <textarea class="form-control" id="dischargeSummary" name="discharge_summary" rows="4" placeholder="Summary of treatment and condition at discharge"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="followUpInstructions" class="form-label">Follow-up Instructions</label>
                        <textarea class="form-control" id="followUpInstructions" name="follow_up_instructions" rows="3" placeholder="Post-discharge care instructions"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Discharge Patient</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bed Management Modal -->
<div class="modal fade" id="bedManagementModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-bed me-2"></i>Bed Management</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <p class="text-muted">Real-time bed availability and management interface will be implemented here.</p>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            This feature allows you to view and manage bed assignments across all wards.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Set default admission date to current date/time
    const now = new Date();
    const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    $('#admissionDate').val(localDateTime);
    $('#dischargeDate').val(localDateTime);

    // Ward selection change - populate available beds
    $('#wardSelect').change(function() {
        const ward = $(this).val();
        $('#bedNumber').html('<option value="">Select Bed</option>');
        
        if (ward) {
            // TODO: Fetch available beds for selected ward
            // For now, add some sample beds
            const sampleBeds = ['001', '002', '003', '004', '005'];
            sampleBeds.forEach(bed => {
                $('#bedNumber').append(`<option value="${bed}">${bed}</option>`);
            });
        }
    });

    // Add admission form submission
    $('#addAdmissionForm').submit(function(e) {
        e.preventDefault();
        // TODO: Implement admission creation via AJAX
        alert('Admission creation functionality to be implemented');
    });

    // Discharge form submission
    $('#dischargeForm').submit(function(e) {
        e.preventDefault();
        // TODO: Implement discharge functionality via AJAX
        alert('Discharge functionality to be implemented');
    });

    // View admission details
    $('.view-admission').click(function() {
        const admissionId = $(this).data('admission-id');
        // TODO: Implement admission details modal
        alert('View admission details for ID: ' + admissionId);
    });

    // Discharge patient
    $('.discharge-patient').click(function() {
        const admissionId = $(this).data('admission-id');
        $('#dischargeAdmissionId').val(admissionId);
        $('#dischargeModal').modal('show');
    });

    // Transfer patient
    $('.transfer-patient').click(function() {
        const admissionId = $(this).data('admission-id');
        // TODO: Implement transfer functionality
        alert('Transfer patient functionality to be implemented for ID: ' + admissionId);
    });

    // Update admission
    $('.update-admission').click(function(e) {
        e.preventDefault();
        const admissionId = $(this).data('admission-id');
        // TODO: Implement admission update modal
        alert('Update admission functionality to be implemented for ID: ' + admissionId);
    });

    // Medical history
    $('.medical-history').click(function(e) {
        e.preventDefault();
        const admissionId = $(this).data('admission-id');
        // TODO: Show medical history
        alert('Medical history functionality to be implemented for ID: ' + admissionId);
    });

    // Print admission
    $('.print-admission').click(function(e) {
        e.preventDefault();
        const admissionId = $(this).data('admission-id');
        // TODO: Implement printing
        alert('Print admission functionality to be implemented for ID: ' + admissionId);
    });

    // View discharge details
    $('.view-discharge').click(function() {
        const dischargeId = $(this).data('discharge-id');
        // TODO: Implement discharge details modal
        alert('View discharge details for ID: ' + dischargeId);
    });
});
</script>
{% endblock %}
