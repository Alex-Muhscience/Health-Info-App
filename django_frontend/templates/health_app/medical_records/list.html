{% extends 'base.html' %}

{% block title %}Medical Records - Health Management System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-file-medical me-2"></i>Medical Records
            </h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRecordModal">
                <i class="fas fa-plus me-2"></i>New Record
            </button>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ stats.total_records|default:0 }}</h4>
                        <small>Total Records</small>
                    </div>
                    <i class="fas fa-file-medical-alt fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ stats.records_today|default:0 }}</h4>
                        <small>Records Today</small>
                    </div>
                    <i class="fas fa-calendar-day fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ stats.active_patients|default:0 }}</h4>
                        <small>Active Patients</small>
                    </div>
                    <i class="fas fa-user-check fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ stats.pending_reviews|default:0 }}</h4>
                        <small>Pending Reviews</small>
                    </div>
                    <i class="fas fa-clock fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filter -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-search me-2"></i>Search & Filter</h6>
            </div>
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-3">
                        <label for="search" class="form-label">Search</label>
                        <input type="text" class="form-control" id="search" name="search" placeholder="Patient name, record type..." value="{{ request.GET.search }}">
                    </div>
                    <div class="col-md-2">
                        <label for="record_type" class="form-label">Record Type</label>
                        <select class="form-select" id="record_type" name="record_type">
                            <option value="">All Types</option>
                            <option value="consultation" {% if request.GET.record_type == 'consultation' %}selected{% endif %}>Consultation</option>
                            <option value="diagnosis" {% if request.GET.record_type == 'diagnosis' %}selected{% endif %}>Diagnosis</option>
                            <option value="treatment" {% if request.GET.record_type == 'treatment' %}selected{% endif %}>Treatment</option>
                            <option value="prescription" {% if request.GET.record_type == 'prescription' %}selected{% endif %}>Prescription</option>
                            <option value="lab_result" {% if request.GET.record_type == 'lab_result' %}selected{% endif %}>Lab Result</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="date_from" class="form-label">From Date</label>
                        <input type="date" class="form-control" id="date_from" name="date_from" value="{{ request.GET.date_from }}">
                    </div>
                    <div class="col-md-2">
                        <label for="date_to" class="form-label">To Date</label>
                        <input type="date" class="form-control" id="date_to" name="date_to" value="{{ request.GET.date_to }}">
                    </div>
                    <div class="col-md-2">
                        <label for="doctor" class="form-label">Doctor</label>
                        <select class="form-select" id="doctor" name="doctor">
                            <option value="">All Doctors</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Medical Records Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Medical Records
                </h5>
            </div>
            <div class="card-body">
                {% if medical_records %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Record ID</th>
                                    <th>Patient</th>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Doctor</th>
                                    <th>Chief Complaint</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in medical_records %}
                                <tr>
                                    <td><strong>#{{ record.id }}</strong></td>
                                    <td>
                                        {% if record.client_name %}
                                            {{ record.client_name }}
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.record_type == 'consultation' %}
                                            <span class="badge bg-primary">Consultation</span>
                                        {% elif record.record_type == 'diagnosis' %}
                                            <span class="badge bg-info">Diagnosis</span>
                                        {% elif record.record_type == 'treatment' %}
                                            <span class="badge bg-success">Treatment</span>
                                        {% elif record.record_type == 'prescription' %}
                                            <span class="badge bg-warning">Prescription</span>
                                        {% elif record.record_type == 'lab_result' %}
                                            <span class="badge bg-secondary">Lab Result</span>
                                        {% else %}
                                            <span class="badge bg-dark">{{ record.record_type|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ record.record_date|date:"M d, Y H:i" }}</td>
                                    <td>{{ record.doctor_name|default:"N/A" }}</td>
                                    <td>
                                        {% if record.chief_complaint %}
                                            {{ record.chief_complaint|truncatechars:50 }}
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.status == 'draft' %}
                                            <span class="badge bg-secondary">Draft</span>
                                        {% elif record.status == 'completed' %}
                                            <span class="badge bg-success">Completed</span>
                                        {% elif record.status == 'under_review' %}
                                            <span class="badge bg-warning">Under Review</span>
                                        {% else %}
                                            <span class="badge bg-info">{{ record.status|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-primary view-record" data-record-id="{{ record.id }}" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-info edit-record" data-record-id="{{ record.id }}" title="Edit Record">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-success print-record" data-record-id="{{ record.id }}" title="Print Record">
                                                <i class="fas fa-print"></i>
                                            </button>
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item share-record" href="#" data-record-id="{{ record.id }}"><i class="fas fa-share me-2"></i>Share</a></li>
                                                    <li><a class="dropdown-item export-record" href="#" data-record-id="{{ record.id }}"><i class="fas fa-download me-2"></i>Export</a></li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item text-danger archive-record" href="#" data-record-id="{{ record.id }}"><i class="fas fa-archive me-2"></i>Archive</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-file-medical fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No Medical Records Found</h4>
                        <p class="text-muted">Get started by creating your first medical record.</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRecordModal">
                            <i class="fas fa-plus me-2"></i>Create First Record
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Medical Record Modal -->
<div class="modal fade" id="addRecordModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>New Medical Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addRecordForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="patientSelect" class="form-label">Patient</label>
                                <select class="form-select" id="patientSelect" name="client_id" required>
                                    <option value="">Select Patient</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="recordType" class="form-label">Record Type</label>
                                <select class="form-select" id="recordType" name="record_type" required>
                                    <option value="">Select Type</option>
                                    <option value="consultation">Consultation</option>
                                    <option value="diagnosis">Diagnosis</option>
                                    <option value="treatment">Treatment</option>
                                    <option value="prescription">Prescription</option>
                                    <option value="lab_result">Lab Result</option>
                                    <option value="follow_up">Follow-up</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="recordDate" class="form-label">Record Date</label>
                                <input type="datetime-local" class="form-control" id="recordDate" name="record_date" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="appointmentSelect" class="form-label">Related Appointment</label>
                                <select class="form-select" id="appointmentSelect" name="appointment_id">
                                    <option value="">Select Appointment (Optional)</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="chiefComplaint" class="form-label">Chief Complaint</label>
                        <textarea class="form-control" id="chiefComplaint" name="chief_complaint" rows="2" placeholder="Primary reason for the visit"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="historyPresentIllness" class="form-label">History of Present Illness</label>
                        <textarea class="form-control" id="historyPresentIllness" name="history_present_illness" rows="3" placeholder="Detailed description of the current complaint"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="examination" class="form-label">Physical Examination</label>
                                <textarea class="form-control" id="examination" name="examination" rows="4" placeholder="Physical examination findings"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="vitalSigns" class="form-label">Vital Signs</label>
                                <textarea class="form-control" id="vitalSigns" name="vital_signs" rows="4" placeholder="BP, HR, Temperature, etc."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="assessment" class="form-label">Assessment/Diagnosis</label>
                        <textarea class="form-control" id="assessment" name="assessment" rows="3" placeholder="Clinical assessment and diagnosis"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="treatmentPlan" class="form-label">Treatment Plan</label>
                        <textarea class="form-control" id="treatmentPlan" name="treatment_plan" rows="3" placeholder="Recommended treatment and medications"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="followUpDate" class="form-label">Follow-up Date</label>
                                <input type="date" class="form-control" id="followUpDate" name="follow_up_date">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="priority" class="form-label">Priority</label>
                                <select class="form-select" id="priority" name="priority">
                                    <option value="routine">Routine</option>
                                    <option value="urgent">Urgent</option>
                                    <option value="emergency">Emergency</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Additional Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2" placeholder="Any additional notes or observations"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-primary" id="saveDraft">Save as Draft</button>
                    <button type="submit" class="btn btn-primary">Save Record</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Record Modal -->
<div class="modal fade" id="viewRecordModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-eye me-2"></i>Medical Record Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="recordDetailsContent">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-primary" id="editFromView">Edit Record</button>
                <button type="button" class="btn btn-outline-info" id="printFromView">Print Record</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Set default date to current date/time
    const now = new Date();
    const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    $('#recordDate').val(localDateTime);

    // Add record form submission
    $('#addRecordForm').submit(function(e) {
        e.preventDefault();
        // TODO: Implement record creation via AJAX
        alert('Medical record creation functionality to be implemented');
    });

    // Save as draft
    $('#saveDraft').click(function() {
        // TODO: Implement save as draft functionality
        alert('Save as draft functionality to be implemented');
    });

    // View record details
    $('.view-record').click(function() {
        const recordId = $(this).data('record-id');
        // TODO: Load record details and show modal
        $('#viewRecordModal').modal('show');
        $('#recordDetailsContent').html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>');
        // Simulate loading
        setTimeout(() => {
            $('#recordDetailsContent').html(`
                <div class="row">
                    <div class="col-md-6">
                        <h6>Patient Information</h6>
                        <p><strong>Name:</strong> John Doe</p>
                        <p><strong>Age:</strong> 35</p>
                        <p><strong>Gender:</strong> Male</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Record Information</h6>
                        <p><strong>Type:</strong> Consultation</p>
                        <p><strong>Date:</strong> Today</p>
                        <p><strong>Doctor:</strong> Dr. Smith</p>
                    </div>
                </div>
                <hr>
                <div class="mb-3">
                    <h6>Chief Complaint</h6>
                    <p>Sample chief complaint for record ID: ${recordId}</p>
                </div>
                <div class="mb-3">
                    <h6>Assessment</h6>
                    <p>Sample assessment details...</p>
                </div>
                <div class="mb-3">
                    <h6>Treatment Plan</h6>
                    <p>Sample treatment plan...</p>
                </div>
            `);
        }, 1000);
    });

    // Edit record
    $('.edit-record').click(function() {
        const recordId = $(this).data('record-id');
        // TODO: Implement record editing
        alert('Edit record functionality to be implemented for ID: ' + recordId);
    });

    // Print record
    $('.print-record').click(function() {
        const recordId = $(this).data('record-id');
        // TODO: Implement record printing
        alert('Print record functionality to be implemented for ID: ' + recordId);
    });

    // Share record
    $('.share-record').click(function(e) {
        e.preventDefault();
        const recordId = $(this).data('record-id');
        // TODO: Implement record sharing
        alert('Share record functionality to be implemented for ID: ' + recordId);
    });

    // Export record
    $('.export-record').click(function(e) {
        e.preventDefault();
        const recordId = $(this).data('record-id');
        // TODO: Implement record export
        alert('Export record functionality to be implemented for ID: ' + recordId);
    });

    // Archive record
    $('.archive-record').click(function(e) {
        e.preventDefault();
        const recordId = $(this).data('record-id');
        if (confirm('Are you sure you want to archive this record?')) {
            // TODO: Implement record archiving
            alert('Archive record functionality to be implemented for ID: ' + recordId);
        }
    });

    // Edit from view modal
    $('#editFromView').click(function() {
        $('#viewRecordModal').modal('hide');
        // TODO: Open edit modal with current record data
        alert('Edit functionality to be implemented');
    });

    // Print from view modal
    $('#printFromView').click(function() {
        // TODO: Implement printing from view modal
        alert('Print functionality to be implemented');
    });
});
</script>
{% endblock %}
