{% extends 'base.html' %}

{% block title %}Billing - Health Management System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-receipt me-2"></i>Billing Management
            </h1>
            <div class="btn-group" role="group">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBillModal">
                    <i class="fas fa-plus me-2"></i>New Bill
                </button>
                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#generateReportModal">
                    <i class="fas fa-chart-bar me-2"></i>Generate Report
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">${{ stats.total_revenue|default:0 }}</h4>
                        <small>Total Revenue</small>
                    </div>
                    <i class="fas fa-dollar-sign fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">${{ stats.pending_amount|default:0 }}</h4>
                        <small>Pending Bills</small>
                    </div>
                    <i class="fas fa-clock fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">${{ stats.paid_today|default:0 }}</h4>
                        <small>Paid Today</small>
                    </div>
                    <i class="fas fa-check-circle fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ stats.overdue_count|default:0 }}</h4>
                        <small>Overdue Bills</small>
                    </div>
                    <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filter -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-search me-2"></i>Search & Filter</h6>
            </div>
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-3">
                        <label for="search" class="form-label">Search</label>
                        <input type="text" class="form-control" id="search" name="search" placeholder="Bill ID, patient name..." value="{{ request.GET.search }}">
                    </div>
                    <div class="col-md-2">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">All Status</option>
                            <option value="draft" {% if request.GET.status == 'draft' %}selected{% endif %}>Draft</option>
                            <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
                            <option value="paid" {% if request.GET.status == 'paid' %}selected{% endif %}>Paid</option>
                            <option value="overdue" {% if request.GET.status == 'overdue' %}selected{% endif %}>Overdue</option>
                            <option value="cancelled" {% if request.GET.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="payment_method" class="form-label">Payment Method</label>
                        <select class="form-select" id="payment_method" name="payment_method">
                            <option value="">All Methods</option>
                            <option value="cash" {% if request.GET.payment_method == 'cash' %}selected{% endif %}>Cash</option>
                            <option value="card" {% if request.GET.payment_method == 'card' %}selected{% endif %}>Card</option>
                            <option value="insurance" {% if request.GET.payment_method == 'insurance' %}selected{% endif %}>Insurance</option>
                            <option value="bank_transfer" {% if request.GET.payment_method == 'bank_transfer' %}selected{% endif %}>Bank Transfer</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="date_from" class="form-label">From Date</label>
                        <input type="date" class="form-control" id="date_from" name="date_from" value="{{ request.GET.date_from }}">
                    </div>
                    <div class="col-md-2">
                        <label for="date_to" class="form-label">To Date</label>
                        <input type="date" class="form-control" id="date_to" name="date_to" value="{{ request.GET.date_to }}">
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Billing Records -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Billing Records
                </h5>
            </div>
            <div class="card-body">
                {% if billing_records %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Bill ID</th>
                                    <th>Patient</th>
                                    <th>Date</th>
                                    <th>Services</th>
                                    <th>Total Amount</th>
                                    <th>Paid Amount</th>
                                    <th>Balance</th>
                                    <th>Status</th>
                                    <th>Payment Method</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bill in billing_records %}
                                <tr>
                                    <td><strong>#{{ bill.id }}</strong></td>
                                    <td>
                                        {% if bill.client_name %}
                                            {{ bill.client_name }}
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ bill.bill_date|date:"M d, Y" }}</td>
                                    <td>
                                        {% if bill.services %}
                                            {{ bill.services|truncatechars:30 }}
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td><strong>${{ bill.total_amount|default:0 }}</strong></td>
                                    <td>${{ bill.paid_amount|default:0 }}</td>
                                    <td>
                                        {% if bill.balance > 0 %}
                                            <span class="text-danger">${{ bill.balance }}</span>
                                        {% else %}
                                            <span class="text-success">$0.00</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if bill.status == 'draft' %}
                                            <span class="badge bg-secondary">Draft</span>
                                        {% elif bill.status == 'pending' %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% elif bill.status == 'paid' %}
                                            <span class="badge bg-success">Paid</span>
                                        {% elif bill.status == 'overdue' %}
                                            <span class="badge bg-danger">Overdue</span>
                                        {% elif bill.status == 'cancelled' %}
                                            <span class="badge bg-dark">Cancelled</span>
                                        {% else %}
                                            <span class="badge bg-info">{{ bill.status|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if bill.payment_method %}
                                            {{ bill.payment_method|title }}
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-primary view-bill" data-bill-id="{{ bill.id }}" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if bill.status != 'paid' and bill.status != 'cancelled' %}
                                            <button class="btn btn-sm btn-outline-success record-payment" data-bill-id="{{ bill.id }}" title="Record Payment">
                                                <i class="fas fa-credit-card"></i>
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-sm btn-outline-info print-bill" data-bill-id="{{ bill.id }}" title="Print Bill">
                                                <i class="fas fa-print"></i>
                                            </button>
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item edit-bill" href="#" data-bill-id="{{ bill.id }}"><i class="fas fa-edit me-2"></i>Edit</a></li>
                                                    <li><a class="dropdown-item duplicate-bill" href="#" data-bill-id="{{ bill.id }}"><i class="fas fa-copy me-2"></i>Duplicate</a></li>
                                                    <li><a class="dropdown-item send-reminder" href="#" data-bill-id="{{ bill.id }}"><i class="fas fa-bell me-2"></i>Send Reminder</a></li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    {% if bill.status != 'cancelled' %}
                                                    <li><a class="dropdown-item text-danger cancel-bill" href="#" data-bill-id="{{ bill.id }}"><i class="fas fa-times me-2"></i>Cancel</a></li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No Billing Records Found</h4>
                        <p class="text-muted">Get started by creating your first bill.</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBillModal">
                            <i class="fas fa-plus me-2"></i>Create First Bill
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Bill Modal -->
<div class="modal fade" id="addBillModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>New Bill</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addBillForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="patientSelect" class="form-label">Patient</label>
                                <select class="form-select" id="patientSelect" name="client_id" required>
                                    <option value="">Select Patient</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="billDate" class="form-label">Bill Date</label>
                                <input type="date" class="form-control" id="billDate" name="bill_date" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="appointmentSelect" class="form-label">Related Appointment</label>
                                <select class="form-select" id="appointmentSelect" name="appointment_id">
                                    <option value="">Select Appointment (Optional)</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="dueDate" class="form-label">Due Date</label>
                                <input type="date" class="form-control" id="dueDate" name="due_date">
                            </div>
                        </div>
                    </div>

                    <!-- Services Section -->
                    <div class="mb-3">
                        <label class="form-label">Services & Charges</label>
                        <div id="servicesContainer">
                            <div class="service-item border rounded p-3 mb-2">
                                <div class="row">
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" name="service_name[]" placeholder="Service name" required>
                                    </div>
                                    <div class="col-md-3">
                                        <input type="number" class="form-control quantity" name="quantity[]" placeholder="Qty" min="1" value="1" required>
                                    </div>
                                    <div class="col-md-3">
                                        <input type="number" class="form-control unit-price" name="unit_price[]" placeholder="Unit price" step="0.01" min="0" required>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="text" class="form-control line-total" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="addService">
                            <i class="fas fa-plus me-1"></i>Add Service
                        </button>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="discount" class="form-label">Discount (%)</label>
                                <input type="number" class="form-control" id="discount" name="discount" min="0" max="100" step="0.01" value="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tax" class="form-label">Tax (%)</label>
                                <input type="number" class="form-control" id="tax" name="tax" min="0" max="50" step="0.01" value="0">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="notes" class="form-label">Notes</label>
                                <textarea class="form-control" id="notes" name="notes" rows="2" placeholder="Additional notes or terms"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Bill Summary</h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <span>Subtotal:</span>
                                        <span id="subtotal">$0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Discount:</span>
                                        <span id="discountAmount">$0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Tax:</span>
                                        <span id="taxAmount">$0.00</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <strong>Total:</strong>
                                        <strong id="totalAmount">$0.00</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-primary" id="saveDraft">Save as Draft</button>
                    <button type="submit" class="btn btn-primary">Create Bill</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Record Payment Modal -->
<div class="modal fade" id="recordPaymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-credit-card me-2"></i>Record Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="recordPaymentForm">
                <div class="modal-body">
                    <input type="hidden" id="paymentBillId" name="bill_id">
                    <div class="mb-3">
                        <label for="paymentAmount" class="form-label">Payment Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="paymentAmount" name="amount" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label">Payment Method</label>
                        <select class="form-select" id="paymentMethod" name="payment_method" required>
                            <option value="">Select Method</option>
                            <option value="cash">Cash</option>
                            <option value="card">Credit/Debit Card</option>
                            <option value="insurance">Insurance</option>
                            <option value="bank_transfer">Bank Transfer</option>
                            <option value="check">Check</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="paymentDate" class="form-label">Payment Date</label>
                        <input type="date" class="form-control" id="paymentDate" name="payment_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="reference" class="form-label">Reference/Transaction ID</label>
                        <input type="text" class="form-control" id="reference" name="reference" placeholder="Optional">
                    </div>
                    <div class="mb-3">
                        <label for="paymentNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="paymentNotes" name="notes" rows="2" placeholder="Payment notes"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Record Payment</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Generate Report Modal -->
<div class="modal fade" id="generateReportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-chart-bar me-2"></i>Generate Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="generateReportForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="reportType" class="form-label">Report Type</label>
                        <select class="form-select" id="reportType" name="report_type" required>
                            <option value="">Select Report Type</option>
                            <option value="revenue">Revenue Report</option>
                            <option value="outstanding">Outstanding Bills</option>
                            <option value="payment_summary">Payment Summary</option>
                            <option value="patient_billing">Patient Billing History</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="reportDateFrom" class="form-label">From Date</label>
                                <input type="date" class="form-control" id="reportDateFrom" name="date_from" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="reportDateTo" class="form-label">To Date</label>
                                <input type="date" class="form-control" id="reportDateTo" name="date_to" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="reportFormat" class="form-label">Format</label>
                        <select class="form-select" id="reportFormat" name="format">
                            <option value="pdf">PDF</option>
                            <option value="excel">Excel</option>
                            <option value="csv">CSV</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Generate Report</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Set default dates
    const today = new Date().toISOString().split('T')[0];
    $('#billDate').val(today);
    $('#paymentDate').val(today);
    
    // Calculate due date (30 days from bill date)
    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + 30);
    $('#dueDate').val(dueDate.toISOString().split('T')[0]);

    // Add service functionality
    $('#addService').click(function() {
        const serviceItem = `
            <div class="service-item border rounded p-3 mb-2">
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" class="form-control" name="service_name[]" placeholder="Service name" required>
                    </div>
                    <div class="col-md-3">
                        <input type="number" class="form-control quantity" name="quantity[]" placeholder="Qty" min="1" value="1" required>
                    </div>
                    <div class="col-md-3">
                        <input type="number" class="form-control unit-price" name="unit_price[]" placeholder="Unit price" step="0.01" min="0" required>
                    </div>
                    <div class="col-md-2">
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="text" class="form-control line-total" readonly>
                            <button type="button" class="btn btn-outline-danger btn-sm remove-service" title="Remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        $('#servicesContainer').append(serviceItem);
    });

    // Remove service functionality
    $(document).on('click', '.remove-service', function() {
        $(this).closest('.service-item').remove();
        calculateTotals();
    });

    // Calculate line totals and overall totals
    $(document).on('input', '.quantity, .unit-price, #discount, #tax', function() {
        calculateTotals();
    });

    function calculateTotals() {
        let subtotal = 0;
        
        $('.service-item').each(function() {
            const quantity = parseFloat($(this).find('.quantity').val()) || 0;
            const unitPrice = parseFloat($(this).find('.unit-price').val()) || 0;
            const lineTotal = quantity * unitPrice;
            
            $(this).find('.line-total').val(lineTotal.toFixed(2));
            subtotal += lineTotal;
        });
        
        const discount = parseFloat($('#discount').val()) || 0;
        const tax = parseFloat($('#tax').val()) || 0;
        
        const discountAmount = (subtotal * discount) / 100;
        const taxableAmount = subtotal - discountAmount;
        const taxAmount = (taxableAmount * tax) / 100;
        const total = taxableAmount + taxAmount;
        
        $('#subtotal').text('$' + subtotal.toFixed(2));
        $('#discountAmount').text('$' + discountAmount.toFixed(2));
        $('#taxAmount').text('$' + taxAmount.toFixed(2));
        $('#totalAmount').text('$' + total.toFixed(2));
    }

    // Form submissions
    $('#addBillForm').submit(function(e) {
        e.preventDefault();
        // TODO: Implement bill creation via AJAX
        alert('Bill creation functionality to be implemented');
    });

    $('#recordPaymentForm').submit(function(e) {
        e.preventDefault();
        // TODO: Implement payment recording via AJAX
        alert('Payment recording functionality to be implemented');
    });

    $('#generateReportForm').submit(function(e) {
        e.preventDefault();
        // TODO: Implement report generation
        alert('Report generation functionality to be implemented');
    });

    // Save as draft
    $('#saveDraft').click(function() {
        // TODO: Implement save as draft functionality
        alert('Save as draft functionality to be implemented');
    });

    // View bill details
    $('.view-bill').click(function() {
        const billId = $(this).data('bill-id');
        // TODO: Implement bill details modal
        alert('View bill details for ID: ' + billId);
    });

    // Record payment
    $('.record-payment').click(function() {
        const billId = $(this).data('bill-id');
        $('#paymentBillId').val(billId);
        $('#recordPaymentModal').modal('show');
    });

    // Print bill
    $('.print-bill').click(function() {
        const billId = $(this).data('bill-id');
        // TODO: Implement bill printing
        alert('Print bill functionality to be implemented for ID: ' + billId);
    });

    // Edit bill
    $('.edit-bill').click(function(e) {
        e.preventDefault();
        const billId = $(this).data('bill-id');
        // TODO: Implement bill editing
        alert('Edit bill functionality to be implemented for ID: ' + billId);
    });

    // Duplicate bill
    $('.duplicate-bill').click(function(e) {
        e.preventDefault();
        const billId = $(this).data('bill-id');
        // TODO: Implement bill duplication
        alert('Duplicate bill functionality to be implemented for ID: ' + billId);
    });

    // Send reminder
    $('.send-reminder').click(function(e) {
        e.preventDefault();
        const billId = $(this).data('bill-id');
        // TODO: Implement reminder sending
        alert('Send reminder functionality to be implemented for ID: ' + billId);
    });

    // Cancel bill
    $('.cancel-bill').click(function(e) {
        e.preventDefault();
        const billId = $(this).data('bill-id');
        if (confirm('Are you sure you want to cancel this bill?')) {
            // TODO: Implement bill cancellation
            alert('Cancel bill functionality to be implemented for ID: ' + billId);
        }
    });

    // Initialize totals calculation
    calculateTotals();
});
</script>
{% endblock %}
