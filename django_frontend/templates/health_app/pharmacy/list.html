{% extends 'base.html' %}

{% block title %}Pharmacy - Health Management System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-pills me-2"></i>Pharmacy Management
            </h1>
            <div class="btn-group" role="group">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPrescriptionModal">
                    <i class="fas fa-plus me-2"></i>New Prescription
                </button>
                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addMedicationModal">
                    <i class="fas fa-capsules me-2"></i>Add Medication
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ stats.pending_prescriptions|default:0 }}</h4>
                        <small>Pending Prescriptions</small>
                    </div>
                    <i class="fas fa-prescription fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ stats.low_stock|default:0 }}</h4>
                        <small>Low Stock Items</small>
                    </div>
                    <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ stats.dispensed_today|default:0 }}</h4>
                        <small>Dispensed Today</small>
                    </div>
                    <i class="fas fa-check-circle fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ stats.expired_items|default:0 }}</h4>
                        <small>Expired Items</small>
                    </div>
                    <i class="fas fa-calendar-times fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pharmacy Management Tabs -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="prescriptions-tab" data-bs-toggle="tab" data-bs-target="#prescriptions" type="button" role="tab">
                            <i class="fas fa-prescription me-2"></i>Prescriptions
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="medications-tab" data-bs-toggle="tab" data-bs-target="#medications" type="button" role="tab">
                            <i class="fas fa-capsules me-2"></i>Medications
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab">
                            <i class="fas fa-boxes me-2"></i>Inventory
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    <!-- Prescriptions Tab -->
                    <div class="tab-pane fade show active" id="prescriptions" role="tabpanel">
                        {% if prescriptions %}
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Prescription ID</th>
                                            <th>Patient</th>
                                            <th>Prescribed By</th>
                                            <th>Medication</th>
                                            <th>Dosage</th>
                                            <th>Frequency</th>
                                            <th>Duration</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for prescription in prescriptions %}
                                        <tr>
                                            <td><strong>#{{ prescription.id }}</strong></td>
                                            <td>{{ prescription.client_name|default:"N/A" }}</td>
                                            <td>{{ prescription.prescribed_by_name|default:"N/A" }}</td>
                                            <td>{{ prescription.medication_name|default:"N/A" }}</td>
                                            <td>{{ prescription.dosage|default:"N/A" }}</td>
                                            <td>{{ prescription.frequency|default:"N/A" }}</td>
                                            <td>{{ prescription.duration|default:"N/A" }}</td>
                                            <td>
                                                {% if prescription.status == 'pending' %}
                                                    <span class="badge bg-warning">Pending</span>
                                                {% elif prescription.status == 'dispensed' %}
                                                    <span class="badge bg-success">Dispensed</span>
                                                {% elif prescription.status == 'cancelled' %}
                                                    <span class="badge bg-danger">Cancelled</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ prescription.status|title }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <button class="btn btn-sm btn-outline-primary view-prescription" data-prescription-id="{{ prescription.id }}" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    {% if prescription.status == 'pending' %}
                                                    <button class="btn btn-sm btn-outline-success dispense-prescription" data-prescription-id="{{ prescription.id }}" title="Dispense">
                                                        <i class="fas fa-hand-holding-medical"></i>
                                                    </button>
                                                    {% endif %}
                                                    <button class="btn btn-sm btn-outline-info print-prescription" data-prescription-id="{{ prescription.id }}" title="Print">
                                                        <i class="fas fa-print"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-prescription fa-3x text-muted mb-3"></i>
                                <h4 class="text-muted">No Prescriptions Found</h4>
                                <p class="text-muted">Get started by creating your first prescription.</p>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPrescriptionModal">
                                    <i class="fas fa-plus me-2"></i>Create First Prescription
                                </button>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Medications Tab -->
                    <div class="tab-pane fade" id="medications" role="tabpanel">
                        {% if medications %}
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Name</th>
                                            <th>Generic Name</th>
                                            <th>Category</th>
                                            <th>Strength</th>
                                            <th>Form</th>
                                            <th>Manufacturer</th>
                                            <th>Stock</th>
                                            <th>Unit Price</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for medication in medications %}
                                        <tr>
                                            <td><strong>{{ medication.name }}</strong></td>
                                            <td>{{ medication.generic_name|default:"N/A" }}</td>
                                            <td>{{ medication.category|default:"N/A" }}</td>
                                            <td>{{ medication.strength|default:"N/A" }}</td>
                                            <td>{{ medication.form|default:"N/A" }}</td>
                                            <td>{{ medication.manufacturer|default:"N/A" }}</td>
                                            <td>
                                                {% if medication.stock_quantity <= medication.minimum_stock %}
                                                    <span class="badge bg-danger">{{ medication.stock_quantity|default:0 }}</span>
                                                {% elif medication.stock_quantity <= medication.reorder_level %}
                                                    <span class="badge bg-warning">{{ medication.stock_quantity|default:0 }}</span>
                                                {% else %}
                                                    <span class="badge bg-success">{{ medication.stock_quantity|default:0 }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if medication.unit_price %}
                                                    ${{ medication.unit_price }}
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if medication.is_active %}
                                                    <span class="badge bg-success">Active</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Inactive</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <button class="btn btn-sm btn-outline-primary view-medication" data-medication-id="{{ medication.id }}" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-info edit-medication" data-medication-id="{{ medication.id }}" title="Edit">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-warning update-stock" data-medication-id="{{ medication.id }}" title="Update Stock">
                                                        <i class="fas fa-boxes"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-capsules fa-3x text-muted mb-3"></i>
                                <h4 class="text-muted">No Medications Found</h4>
                                <p class="text-muted">Get started by adding your first medication.</p>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMedicationModal">
                                    <i class="fas fa-plus me-2"></i>Add First Medication
                                </button>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Inventory Tab -->
                    <div class="tab-pane fade" id="inventory" role="tabpanel">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-warning text-white">
                                        <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Low Stock Alert</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted">Items below minimum stock level</p>
                                        <div class="list-group list-group-flush">
                                            <!-- Low stock items will be listed here -->
                                            <div class="list-group-item">
                                                <small class="text-muted">No low stock items currently</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-danger text-white">
                                        <h6 class="mb-0"><i class="fas fa-calendar-times me-2"></i>Expiry Alert</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted">Items expiring within 30 days</p>
                                        <div class="list-group list-group-flush">
                                            <!-- Expiring items will be listed here -->
                                            <div class="list-group-item">
                                                <small class="text-muted">No items expiring soon</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Inventory Summary</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <h4 class="text-primary">{{ inventory_stats.total_items|default:0 }}</h4>
                                        <small class="text-muted">Total Items</small>
                                    </div>
                                    <div class="col-md-3">
                                        <h4 class="text-success">${{ inventory_stats.total_value|default:0 }}</h4>
                                        <small class="text-muted">Total Value</small>
                                    </div>
                                    <div class="col-md-3">
                                        <h4 class="text-warning">{{ inventory_stats.low_stock_count|default:0 }}</h4>
                                        <small class="text-muted">Low Stock</small>
                                    </div>
                                    <div class="col-md-3">
                                        <h4 class="text-danger">{{ inventory_stats.expired_count|default:0 }}</h4>
                                        <small class="text-muted">Expired</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Prescription Modal -->
<div class="modal fade" id="addPrescriptionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>New Prescription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addPrescriptionForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="patientSelect" class="form-label">Patient</label>
                                <select class="form-select" id="patientSelect" name="client_id" required>
                                    <option value="">Select Patient</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="medicationSelect" class="form-label">Medication</label>
                                <select class="form-select" id="medicationSelect" name="medication_id" required>
                                    <option value="">Select Medication</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="dosage" class="form-label">Dosage</label>
                                <input type="text" class="form-control" id="dosage" name="dosage" placeholder="e.g., 500mg" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="frequency" class="form-label">Frequency</label>
                                <select class="form-select" id="frequency" name="frequency" required>
                                    <option value="">Select Frequency</option>
                                    <option value="once_daily">Once Daily</option>
                                    <option value="twice_daily">Twice Daily</option>
                                    <option value="three_times_daily">Three Times Daily</option>
                                    <option value="four_times_daily">Four Times Daily</option>
                                    <option value="as_needed">As Needed</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="duration" class="form-label">Duration</label>
                                <input type="text" class="form-control" id="duration" name="duration" placeholder="e.g., 7 days" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quantity" class="form-label">Quantity</label>
                                <input type="number" class="form-control" id="quantity" name="quantity" min="1" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="refills" class="form-label">Refills</label>
                                <input type="number" class="form-control" id="refills" name="refills" min="0" max="5" value="0">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="instructions" class="form-label">Instructions</label>
                        <textarea class="form-control" id="instructions" name="instructions" rows="3" placeholder="Special instructions for the patient"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2" placeholder="Internal notes"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Prescription</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Medication Modal -->
<div class="modal fade" id="addMedicationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-capsules me-2"></i>Add New Medication</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addMedicationForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="medicationName" class="form-label">Medication Name</label>
                                <input type="text" class="form-control" id="medicationName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="genericName" class="form-label">Generic Name</label>
                                <input type="text" class="form-control" id="genericName" name="generic_name">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="category" class="form-label">Category</label>
                                <input type="text" class="form-control" id="category" name="category" placeholder="e.g., Antibiotic">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="strength" class="form-label">Strength</label>
                                <input type="text" class="form-control" id="strength" name="strength" placeholder="e.g., 500mg">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="form" class="form-label">Form</label>
                                <select class="form-select" id="form" name="form">
                                    <option value="">Select Form</option>
                                    <option value="tablet">Tablet</option>
                                    <option value="capsule">Capsule</option>
                                    <option value="syrup">Syrup</option>
                                    <option value="injection">Injection</option>
                                    <option value="cream">Cream</option>
                                    <option value="ointment">Ointment</option>
                                    <option value="drops">Drops</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manufacturer" class="form-label">Manufacturer</label>
                                <input type="text" class="form-control" id="manufacturer" name="manufacturer">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="unitPrice" class="form-label">Unit Price</label>
                                <input type="number" class="form-control" id="unitPrice" name="unit_price" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="stockQuantity" class="form-label">Initial Stock</label>
                                <input type="number" class="form-control" id="stockQuantity" name="stock_quantity" min="0" value="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="minimumStock" class="form-label">Minimum Stock</label>
                                <input type="number" class="form-control" id="minimumStock" name="minimum_stock" min="0" value="10">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="reorderLevel" class="form-label">Reorder Level</label>
                                <input type="number" class="form-control" id="reorderLevel" name="reorder_level" min="0" value="20">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Medication</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Add prescription form submission
    $('#addPrescriptionForm').submit(function(e) {
        e.preventDefault();
        // TODO: Implement prescription creation via AJAX
        alert('Prescription creation functionality to be implemented');
    });

    // Add medication form submission
    $('#addMedicationForm').submit(function(e) {
        e.preventDefault();
        // TODO: Implement medication creation via AJAX
        alert('Medication creation functionality to be implemented');
    });

    // View prescription details
    $('.view-prescription').click(function() {
        const prescriptionId = $(this).data('prescription-id');
        // TODO: Implement prescription details modal
        alert('View prescription details for ID: ' + prescriptionId);
    });

    // Dispense prescription
    $('.dispense-prescription').click(function() {
        const prescriptionId = $(this).data('prescription-id');
        // TODO: Implement prescription dispensing
        alert('Dispense prescription ID: ' + prescriptionId);
    });

    // Print prescription
    $('.print-prescription').click(function() {
        const prescriptionId = $(this).data('prescription-id');
        // TODO: Implement prescription printing
        alert('Print prescription ID: ' + prescriptionId);
    });

    // View medication details
    $('.view-medication').click(function() {
        const medicationId = $(this).data('medication-id');
        // TODO: Implement medication details modal
        alert('View medication details for ID: ' + medicationId);
    });

    // Edit medication
    $('.edit-medication').click(function() {
        const medicationId = $(this).data('medication-id');
        // TODO: Implement medication editing modal
        alert('Edit medication ID: ' + medicationId);
    });

    // Update stock
    $('.update-stock').click(function() {
        const medicationId = $(this).data('medication-id');
        // TODO: Implement stock update modal
        alert('Update stock for medication ID: ' + medicationId);
    });
});
</script>
{% endblock %}
